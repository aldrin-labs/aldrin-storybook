stages:
  - bundle
  - release_generated_build

bundle:
  stage: bundle
  image: node:9.0.0
  only:
    - tags
  script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - touch  ~/.ssh/known_hosts
    - ssh-keygen -f ~/.ssh/known_hosts -R gitlab.com
    - echo "StrictHostKeyChecking no" > ~/.ssh/config
    - echo -e "machine gitlab.com\nlogin gitlab-ci-token\npassword ${CI_JOB_TOKEN}" > ~/.netrc
    - yarn
    - yarn build
    - git config user.email "anibaka9@gmail.com"
    - git config user.name "anibaka"
    - git add -f dist/
    - git checkout -b release-$CI_COMMIT_TAG
    - git commit -m "release $CI_COMMIT_TAG (autogenerated)"
    - git push git+ssh:\/\/git@gitlab.com%https:\/\/gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/crypto_project/frontend/storybook HEAD:release-$CI_COMMIT_TAG
  artifacts:
    paths:
    - ./dist